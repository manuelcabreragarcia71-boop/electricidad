<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instalaciones El√©ctricas</title>
    <style>
        /* --- ESTILOS IGUAL QUE ANTES --- */
        :root { --color-principal: #5eff00; --color-fondo: #000; --texto-claro: #fff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: var(--color-fondo); color: var(--texto-claro); background-image: url('logo.jpeg'); background-attachment: fixed; background-position: center; background-size: cover; }
        .overlay { background-color: rgba(0, 0, 0, 0.94); min-height: 100vh; padding-bottom: 80px; }
        nav { background: #000; padding: 15px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--color-principal); }
        nav ul { list-style: none; display: flex; justify-content: center; gap: 20px; padding: 0; flex-wrap: wrap; margin: 0; }
        nav a { color: #fff; text-decoration: none; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        nav a:hover { color: var(--color-principal); }
        section { padding: 40px 20px; max-width: 1100px; margin: 0 auto; text-align: center; }
        h2 { color: var(--color-principal); border-bottom: 2px solid var(--color-principal); display: inline-block; padding-bottom: 5px; margin-bottom: 30px; }
        .img-controlada { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; background-color: #222; border-bottom: 1px solid #333; }
        .productos-grid, .galeria-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .producto-card { background: #151515; border: 1px solid #333; border-radius: 10px; overflow: hidden; transition: transform 0.3s; }
        .producto-card:hover { transform: translateY(-5px); border-color: var(--color-principal); }
        .info-prod { padding: 15px; }
        .precio { font-size: 1.4rem; color: var(--color-principal); font-weight: bold; margin: 10px 0; }
        .galeria-item { position: relative; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .btn { background-color: var(--color-principal); color: #000; border: none; padding: 10px; cursor: pointer; width: 100%; font-weight: bold; border-radius: 5px; margin-top: 5px; text-transform: uppercase; }
        .btn:hover { background-color: #fff; }
        .btn-danger { background-color: #ff3333; color: white; margin-top: 10px; }
        .btn:disabled { background-color: #555; cursor: not-allowed; }
        .panel-admin { border: 2px dashed var(--color-principal); padding: 20px; background: #1a1a1a; margin-bottom: 30px; text-align: left; border-radius: 10px; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box; }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        .whatsapp-float { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.3s; }
        .whatsapp-float:hover { transform: scale(1.1); }
        .whatsapp-icon { width: 35px; height: 35px; fill: white; }
        #carrito-flotante { position: fixed; bottom: 20px; left: 20px; background: #fff; color: #000; padding: 20px; border-radius: 10px; display: none; z-index: 2000; width: 280px; box-shadow: 0 0 15px var(--color-principal); }
        .cargando { color: var(--color-principal); font-style: italic; }
    </style>
</head>
<body>

<div class="overlay">
    <nav>
        <ul>
            <li><a href="#inicio">Inicio</a></li>
            <li><a href="#tienda">Tienda</a></li>
            <li><a href="#galeria">Galer√≠a</a></li>
            <li><a href="#resenas">Rese√±as</a></li>
            <li><a href="#contacto">Contacto</a></li>
        </ul>
    </nav>

    <section id="inicio">
        <h1>Electricidad Profesional</h1>
        <img src="logo.jpeg" alt="Logo" style="width: 150px; height:150px; object-fit:cover; border-radius: 50%; border: 4px solid var(--color-principal);">
        <div id="texto-nosotros" style="font-size: 1.2rem; margin-top: 20px;">
            <p id="parrafo-inicio">Cargando informaci√≥n...</p>
        </div>
        <button onclick="editarTexto()" class="btn admin-only" style="width: auto; margin-top:20px;">‚úèÔ∏è Editar Texto</button>
    </section>

    <section id="tienda">
        <h2>Tienda Online</h2>
        <div class="panel-admin admin-only">
            <h3>+ A√±adir Nuevo Producto</h3>
            <label>Nombre:</label> <input type="text" id="prodNombre">
            <label>Precio (‚Ç¨):</label> <input type="number" id="prodPrecio">
            <label>Foto:</label> <input type="file" id="prodFoto" accept="image/*">
            <button class="btn" id="btnCrearProd" onclick="crearProducto()">Guardar Producto</button>
        </div>
        <div class="productos-grid" id="lista-productos"><p class="cargando">Cargando productos...</p></div>
    </section>

    <section id="galeria">
        <h2>Nuestros Trabajos</h2>
        <div class="panel-admin admin-only">
            <h3>+ Subir Foto a Galer√≠a</h3>
            <input type="file" id="inputFotoGaleria" accept="image/*">
            <button class="btn" id="btnSubirGaleria" onclick="subirFotoGaleria()">Subir Foto</button>
        </div>
        <div class="galeria-grid" id="contenedor-galeria"><p class="cargando">Cargando fotos...</p></div>
    </section>

    <section id="resenas">
        <h2>Opiniones</h2>
        <div style="background: #222; padding: 20px; border-radius: 10px; text-align: left;">
            <input type="text" id="nombreResena" placeholder="Tu Nombre">
            <textarea id="textoResena" placeholder="Escribe tu opini√≥n..."></textarea>
            <button class="btn" onclick="publicarResena()">Publicar Rese√±a</button>
        </div>
        <div id="lista-resenas" style="margin-top:20px; text-align: left;"><p class="cargando">Cargando opiniones...</p></div>
    </section>

    <section id="contacto">
        <h2>Contacto</h2>
        <p>Ll√°manos o escr√≠benos por WhatsApp para un presupuesto personalizado.</p>
        <button class="btn" style="width: auto; padding: 15px 30px;" onclick="window.open('https://wa.me/34698906201', '_blank')">Contactar al WhatsApp</button>
    </section>

    <footer style="margin-top: 50px; text-align: center; color: #555; padding: 20px;">
        <span onclick="intentarLogin()" style="cursor: pointer;">üîí Admin</span> | &copy; 2026 Electricidad
    </footer>
</div>

<a href="https://wa.me/34698906201" class="whatsapp-float" target="_blank">
    <svg class="whatsapp-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
</a>

<div id="carrito-flotante">
    <h3 style="margin-top:0">Tu Pedido</h3>
    <ul id="lista-carrito" style="padding-left: 20px; max-height: 200px; overflow-y: auto;"></ul>
    <p>Total: <strong><span id="total-carrito">0</span> ‚Ç¨</strong></p>
    <button class="btn" onclick="enviarPedidoWhatsApp()">Pedir por WhatsApp</button>
    <button class="btn btn-danger" onclick="limpiarCarrito()" style="margin-top:5px; font-size:0.8rem;">Vaciar</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN148goDCis9_I4bWP6pGa5_kf4Zce1g8",
      authDomain: "electricidad-a21ba.firebaseapp.com",
      projectId: "electricidad-a21ba",
      storageBucket: "electricidad-a21ba.firebasestorage.app",
      messagingSenderId: "1058554836478",
      appId: "1:1058554836478:web:fda5f537df5a225815fcaf",
      measurementId: "G-YYW79C4EXN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const PIN_ADMIN = "4354";
    const TU_TELEFONO = "34698906201"; 
    let carrito = [];

    // --- FUNCI√ìN ANTI-ERROR: COMPRIMIR IMAGEN ANTES DE SUBIR ---
    // Esto hace que una foto de 5MB pase a ocupar 0.1MB
    function comprimirImagen(archivo) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(archivo);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Ancho m√°ximo
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Convertir a blob comprimido (JPEG calidad 0.7)
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.7);
                }
            }
        });
    }

    // --- SUBIR IMAGEN ---
    async function subirImagenAFirebase(archivo, carpeta) {
        // Primero la comprimimos
        const archivoComprimido = await comprimirImagen(archivo);
        
        const nombreArchivo = `${Date.now()}.jpg`; 
        const storageRef = ref(storage, `${carpeta}/${nombreArchivo}`);
        
        const snapshot = await uploadBytes(storageRef, archivoComprimido);
        const url = await getDownloadURL(snapshot.ref);
        return url;
    }

    /* --- GESTI√ìN PRODUCTOS --- */
    window.cargarProductos = async function() {
        const cont = document.getElementById('lista-productos');
        try {
            const querySnapshot = await getDocs(collection(db, "productos"));
            cont.innerHTML = '';
            if (querySnapshot.empty) { cont.innerHTML = '<p>No hay productos a√∫n.</p>'; return; }
            window.productosCache = []; 
            querySnapshot.forEach((docSnap) => {
                const prod = docSnap.data();
                const id = docSnap.id;
                window.productosCache.push({ id, ...prod });
                cont.innerHTML += `
                <div class="producto-card">
                    <img src="${prod.imagen}" class="img-controlada">
                    <div class="info-prod">
                        <h3>${prod.nombre}</h3>
                        <p class="precio">${prod.precio} ‚Ç¨</p>
                        <button class="btn" onclick="addCarrito('${id}')">A√±adir</button>
                        <button class="btn btn-danger admin-only" onclick="borrarProducto('${id}')">Eliminar</button>
                    </div>
                </div>`;
            });
            window.verificarAdminVisual();
        } catch (error) { console.error(error); cont.innerHTML = '<p>Error de carga (Posible l√≠mite superado).</p>'; }
    }

    window.crearProducto = async function() {
        const nombre = document.getElementById('prodNombre').value;
        const precio = parseFloat(document.getElementById('prodPrecio').value);
        const inputFoto = document.getElementById('prodFoto');
        const btn = document.getElementById('btnCrearProd');

        if(!nombre || !precio || !inputFoto.files[0]) return alert("Faltan datos");

        btn.innerText = "Comprimiendo y Subiendo...";
        btn.disabled = true;

        try {
            const urlImagen = await subirImagenAFirebase(inputFoto.files[0], 'productos');
            await addDoc(collection(db, "productos"), {
                nombre: nombre,
                precio: precio,
                imagen: urlImagen,
                fecha: new Date()
            });
            alert("Producto creado!");
            document.getElementById('prodNombre').value = '';
            document.getElementById('prodPrecio').value = '';
            inputFoto.value = '';
            window.cargarProductos(); 
        } catch (e) {
            alert("Error al subir: " + e.message);
        }
        btn.innerText = "Guardar Producto";
        btn.disabled = false;
    }

    window.borrarProducto = async function(id) {
        if(!confirm("¬øBorrar?")) return;
        await deleteDoc(doc(db, "productos", id));
        window.cargarProductos();
    }

    /* --- CARRITO --- */
    window.addCarrito = function(id) {
        const prod = window.productosCache.find(p => p.id === id);
        if(prod) { carrito.push(prod); window.updateCarrito(); }
    }
    window.updateCarrito = function() {
        const lista = document.getElementById('lista-carrito');
        const box = document.getElementById('carrito-flotante');
        let total = 0; lista.innerHTML = '';
        box.style.display = carrito.length > 0 ? 'block' : 'none';
        carrito.forEach((p, i) => {
            total += p.precio;
            lista.innerHTML += `<li>${p.nombre} - ${p.precio}‚Ç¨ <span style="color:red;cursor:pointer" onclick="delCarrito(${i})">x</span></li>`;
        });
        document.getElementById('total-carrito').innerText = total;
    }
    window.delCarrito = function(i) { carrito.splice(i,1); window.updateCarrito(); }
    window.limpiarCarrito = function() { carrito = []; window.updateCarrito(); }

    window.enviarPedidoWhatsApp = function() {
        if(carrito.length===0) return;
        let msg = "Hola, pedido web:%0A";
        carrito.forEach(p => msg += `- ${p.nombre} (${p.precio}‚Ç¨)%0A`);
        msg += `%0ATotal: ${document.getElementById('total-carrito').innerText}‚Ç¨`;
        window.open(`https://wa.me/${TU_TELEFONO}?text=${msg}`, '_blank');
    }

    /* --- GALER√çA --- */
    window.cargarGalerias = async function() {
        const cont = document.getElementById('contenedor-galeria');
        try {
            const qs = await getDocs(collection(db, "galeria"));
            cont.innerHTML = '';
            qs.forEach((docSnap) => {
                const data = docSnap.data();
                cont.innerHTML += `
                <div class="galeria-item">
                    <img src="${data.url}" class="img-controlada">
                    <button class="btn btn-danger admin-only" onclick="borrarFotoGaleria('${docSnap.id}')" style="position:absolute; bottom:0; border-radius:0;">Eliminar</button>
                </div>`;
            });
            window.verificarAdminVisual();
        } catch(e) {}
    }

    window.subirFotoGaleria = async function() {
        const file = document.getElementById('inputFotoGaleria').files[0];
        const btn = document.getElementById('btnSubirGaleria');
        if(!file) return alert("Elige foto");
        
        btn.innerText = "Comprimiendo..."; btn.disabled = true;
        try {
            const url = await subirImagenAFirebase(file, 'galeria');
            await addDoc(collection(db, "galeria"), { url: url, fecha: new Date() });
            window.cargarGalerias();
        } catch(e) { alert("Error: " + e.message); }
        btn.innerText = "Subir Foto"; btn.disabled = false;
    }

    window.borrarFotoGaleria = async function(id) {
        if(!confirm("¬øBorrar?")) return;
        await deleteDoc(doc(db, "galeria", id));
        window.cargarGalerias();
    }

    /* --- RESE√ëAS --- */
    window.cargarResenas = async function() {
        const lista = document.getElementById('lista-resenas');
        try {
            const qs = await getDocs(collection(db, "resenas"));
            lista.innerHTML = '';
            qs.forEach((docSnap) => {
                const r = docSnap.data();
                lista.innerHTML += `
                <div style="border-bottom:1px solid #333; padding:10px;">
                    <strong style="color:var(--color-principal)">${r.nombre}</strong>
                    <p style="margin:5px 0; color:#ccc">"${r.texto}"</p>
                    <button class="btn btn-danger admin-only" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="borrarResena('${docSnap.id}')">Borrar</button>
                </div>`;
            });
            window.verificarAdminVisual();
        } catch(e) {}
    }

    window.publicarResena = async function() {
        const n = document.getElementById('nombreResena').value;
        const t = document.getElementById('textoResena').value;
        if(!n || !t) return;
        await addDoc(collection(db, "resenas"), { nombre: n, texto: t, fecha: new Date() });
        document.getElementById('nombreResena').value=''; 
        document.getElementById('textoResena').value='';
        window.cargarResenas();
    }
    window.borrarResena = async function(id) { if(confirm("¬øBorrar?")) { await deleteDoc(doc(db, "resenas", id)); window.cargarResenas(); } }

    /* --- TEXTO INICIO --- */
    window.editarTexto = async function() {
        const p = document.getElementById('parrafo-inicio');
        const nuevo = prompt("Nuevo texto:", p.innerText);
        if(!nuevo) return;
        try {
             const qs = await getDocs(collection(db, "configuracion"));
             if(qs.empty) { await addDoc(collection(db, "configuracion"), { texto: nuevo }); } 
             else { const id = qs.docs[0].id; await updateDoc(doc(db, "configuracion", id), { texto: nuevo }); }
             p.innerText = nuevo;
        } catch(e) { console.error(e); }
    }
    async function iniciarTexto() {
         const p = document.getElementById('parrafo-inicio');
         try {
             const qs = await getDocs(collection(db, "configuracion"));
             if(!qs.empty) { p.innerText = qs.docs[0].data().texto; } 
             else { p.innerText = "Bienvenidos. Somos expertos en instalaciones el√©ctricas."; }
         } catch(e) { p.innerText = "Bienvenidos. Somos expertos en instalaciones el√©ctricas."; }
    }

    /* --- ADMIN --- */
    window.intentarLogin = function() {
        if(prompt("PIN:") === PIN_ADMIN) { sessionStorage.setItem('isAdmin', 'true'); window.verificarAdminVisual(); alert("Admin Activado"); }
    }
    window.verificarAdminVisual = function() {
        if(sessionStorage.getItem('isAdmin')==='true') document.body.classList.add('is-admin');
    }

    window.onload = function() {
        window.iniciarTexto(); window.cargarProductos(); window.cargarGalerias(); window.cargarResenas();
    };
</script>
</body>
</html>